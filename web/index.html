<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mailtagger Prompt Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìß Mailtagger Prompt Manager</h1>
            <p class="subtitle">Manage and test your email classification prompts</p>
        </header>

        <!-- Tab Navigation -->
        <nav class="tabs">
            <button class="tab-button" onclick="showTab('dashboard')">
                üì¨ Dashboard
            </button>
            <button class="tab-button active" onclick="showTab('edit')">
                ‚úèÔ∏è Edit Prompt
            </button>
            <button class="tab-button" onclick="showTab('test')">
                üß™ Test
            </button>
            <button class="tab-button" onclick="showTab('stats')">
                üìä Statistics
            </button>
            <button class="tab-button" onclick="showTab('optimize')">
                üöÄ Optimize
            </button>
            <button class="tab-button" onclick="showTab('examples')">
                üìö Examples
            </button>
            <button class="tab-button" onclick="showTab('gmail')">
                üîê Gmail Auth
            </button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="card">
                <h2>Email Dashboard</h2>
                <p class="help-text">
                    Highlights and groupings from your indexed email. Run the categorizer to populate this view.
                </p>

                <div id="dashboard-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading dashboard...</p>
                </div>

                <div id="dashboard-summary" style="margin-bottom: 20px;"></div>

                <div class="dashboard-filters" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <div class="form-group inline">
                        <label for="dashboard-priority">Priority:</label>
                        <select id="dashboard-priority" onchange="loadDashboardEmails()">
                            <option value="">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group inline">
                        <label for="dashboard-category">Category:</label>
                        <select id="dashboard-category" onchange="loadDashboardEmails()">
                            <option value="">All</option>
                            <option value="ecommerce">Ecommerce</option>
                            <option value="political">Political</option>
                            <option value="receipts">Receipts</option>
                            <option value="personal">Personal</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div class="form-group inline">
                        <input type="text" id="dashboard-search" placeholder="Search subject, sender..."
                            style="padding: 6px 10px; min-width: 200px;"
                            onkeypress="if(event.key==='Enter') searchDashboard()">
                        <button class="button button-small" onclick="searchDashboard()">Search</button>
                    </div>
                    <button class="button button-small" onclick="loadDashboardData()">üîÑ Refresh</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h3>Highlights (Recent Emails)</h3>
                        <div id="dashboard-emails"></div>
                    </div>
                    <div>
                        <h3>By Sender</h3>
                        <div id="dashboard-groups"></div>
                    </div>
                </div>

                <div id="dashboard-search-results" style="display: none;">
                    <h3>Search Results</h3>
                    <div id="dashboard-search-list"></div>
                </div>
            </div>
        </div>

        <!-- Edit Tab -->
        <div id="edit-tab" class="tab-content active">
            <div class="card">
                <h2>Edit Classification Prompt</h2>
                <div class="form-group">
                    <label for="prompt-name">Prompt Name:</label>
                    <input type="text" id="prompt-name" placeholder="e.g., Enhanced Classifier v2">
                </div>
                <div class="form-group">
                    <label for="prompt-content">Prompt Content:</label>
                    <textarea 
                        id="prompt-content" 
                        placeholder="Enter your classification prompt here..."
                        rows="20"
                    ></textarea>
                    <p class="help-text">
                        The prompt should instruct the LLM to classify emails into: 
                        <code>ecommerce</code>, <code>political</code>, or <code>none</code>
                    </p>
                </div>
                <div class="button-group">
                    <button class="button button-primary" onclick="savePrompt()">
                        üíæ Save & Activate
                    </button>
                    <button class="button" onclick="loadPrompt()">
                        üîÑ Reload
                    </button>
                </div>
                <div id="save-status"></div>
            </div>
        </div>

        <!-- Test Tab -->
        <div id="test-tab" class="tab-content">
            <div class="card">
                <h2>Test Prompt on Real Emails</h2>
                <div class="test-config">
                    <div class="form-group inline">
                        <label for="email-count">Number of emails:</label>
                        <input type="number" id="email-count" value="10" min="1" max="50">
                    </div>
                    <div class="form-group inline">
                        <label for="test-query">Gmail Query:</label>
                        <input type="text" id="test-query" placeholder="in:inbox newer_than:7d">
                        <p class="help-text-small">Leave empty to use default</p>
                    </div>
                    <button class="button button-primary" onclick="runTest()">
                        üß™ Run Test
                    </button>
                </div>

                <div id="test-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Testing prompt on emails... This may take a minute.</p>
                </div>

                <div id="test-results"></div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats-tab" class="tab-content">
            <div class="card">
                <h2>Performance Statistics</h2>
                <div class="form-group inline">
                    <label for="stats-days">Time period:</label>
                    <select id="stats-days" onchange="loadStats()">
                        <option value="1">Last 24 hours</option>
                        <option value="7" selected>Last 7 days</option>
                        <option value="30">Last 30 days</option>
                    </select>
                    <button class="button button-small" onclick="loadStats()">
                        üîÑ Refresh
                    </button>
                </div>
                
                <div id="stats-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading statistics...</p>
                </div>

                <div id="stats-display"></div>
            </div>
        </div>

        <!-- Optimize Tab -->
        <div id="optimize-tab" class="tab-content">
            <div class="card">
                <h2>DSPy Classifier Optimization</h2>
                <p class="help-text">
                    Use DSPy to automatically optimize your classifier prompts using training data.
                    This improves accuracy through few-shot learning and prompt engineering.
                </p>

                <div class="form-group">
                    <label>Training Dataset:</label>
                    <input type="text" id="train-dataset" placeholder="./data/eval_dataset_train.json" value="./data/eval_dataset_train.json">
                    <p class="help-text-small">Path to training dataset (JSON format)</p>
                </div>

                <div class="form-group">
                    <label>Validation Dataset:</label>
                    <input type="text" id="val-dataset" placeholder="./data/eval_dataset_val.json" value="./data/eval_dataset_val.json">
                    <p class="help-text-small">Path to validation dataset (JSON format)</p>
                </div>

                <div class="form-group inline">
                    <label>Optimizer:</label>
                    <select id="optimizer-type">
                        <option value="bootstrap" selected>Bootstrap FewShot (Fast)</option>
                        <option value="random_search">Random Search (Better)</option>
                        <option value="mipro">MIPRO (Best, Slow)</option>
                    </select>
                </div>

                <div class="form-group inline">
                    <label>Metric:</label>
                    <select id="optimize-metric">
                        <option value="accuracy" selected>Accuracy</option>
                        <option value="weighted">Weighted Accuracy</option>
                        <option value="combined">Combined</option>
                    </select>
                </div>

                <div class="form-group inline">
                    <label>Max Few-Shot Examples:</label>
                    <input type="number" id="max-demos" value="5" min="1" max="10">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="use-cot" checked>
                        Use Chain-of-Thought Reasoning
                    </label>
                </div>

                <button class="button button-primary" onclick="runOptimization()">
                    üöÄ Start Optimization
                </button>

                <div id="optimize-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Running optimization... This may take several minutes.</p>
                </div>

                <div id="optimize-results"></div>
            </div>
        </div>

        <!-- Examples Tab -->
        <div id="examples-tab" class="tab-content">
            <div class="card">
                <h2>Few-Shot Examples</h2>
                <p class="help-text">
                    Manage high-quality examples for few-shot learning.
                    These examples help the classifier learn patterns.
                </p>

                <!-- Example Store Stats -->
                <div id="example-stats" style="margin-bottom: 20px;">
                    <button class="button button-small" onclick="loadExampleStats()">
                        üîÑ Refresh Stats
                    </button>
                </div>

                <!-- Add New Example Form -->
                <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                    <h3>Add New Example</h3>
                    <div class="form-group">
                        <label>Sender:</label>
                        <input type="text" id="example-sender" placeholder="sender@example.com">
                    </div>
                    <div class="form-group">
                        <label>Subject:</label>
                        <input type="text" id="example-subject" placeholder="Email subject">
                    </div>
                    <div class="form-group">
                        <label>Body:</label>
                        <textarea id="example-body" rows="3" placeholder="Email body..."></textarea>
                    </div>
                    <div class="form-group inline">
                        <label>Category:</label>
                        <select id="example-category">
                            <option value="ecommerce">Ecommerce</option>
                            <option value="political">Political</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div class="form-group inline">
                        <label>Confidence:</label>
                        <input type="number" id="example-confidence" value="1.0" min="0" max="1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="example-verified">
                            Mark as Verified
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Notes (optional):</label>
                        <input type="text" id="example-notes" placeholder="Any additional notes">
                    </div>
                    <button class="button button-primary" onclick="addExample()">
                        ‚ûï Add Example
                    </button>
                </div>

                <!-- Examples List -->
                <div>
                    <h3>Existing Examples</h3>
                    <div class="form-group inline">
                        <label>Filter by category:</label>
                        <select id="examples-filter" onchange="loadExamples()">
                            <option value="">All</option>
                            <option value="ecommerce">Ecommerce</option>
                            <option value="political">Political</option>
                            <option value="none">None</option>
                        </select>
                        <button class="button button-small" onclick="loadExamples()">
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <div id="examples-loading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Loading examples...</p>
                    </div>
                    
                    <div id="examples-list"></div>
                </div>
            </div>
        </div>

        <!-- Gmail Auth Tab -->
        <div id="gmail-tab" class="tab-content">
            <div class="card">
                <h2>Gmail Authorization</h2>
                <p class="help-text">
                    Mailtagger needs access to your Gmail account to read and label emails.
                    Your credentials are stored securely on your server only.
                </p>

                <div id="gmail-status-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Checking authorization status...</p>
                </div>

                <div id="gmail-auth-status"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="button button-primary" id="authorize-button" onclick="authorizeGmail()" style="display: none;">
                        üîê Authorize Gmail
                    </button>
                    <button class="button button-danger" id="revoke-button" onclick="revokeGmail()" style="display: none;">
                        üö´ Revoke Authorization
                    </button>
                    <button class="button" onclick="checkGmailStatus()">
                        üîÑ Refresh Status
                    </button>
                </div>

                <div id="gmail-action-status" style="margin-top: 15px;"></div>

                <div class="card" style="margin-top: 30px; background: #f8f9fa;">
                    <h3>üìã Setup Instructions</h3>
                    <ol style="line-height: 1.8;">
                        <li>
                            <strong>Create Google Cloud Project:</strong>
                            <br>Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a>
                            and create a new project.
                        </li>
                        <li>
                            <strong>Enable Gmail API:</strong>
                            <br>In your project, go to "APIs & Services" ‚Üí "Library" ‚Üí Search "Gmail API" ‚Üí Enable
                        </li>
                        <li>
                            <strong>Create OAuth Credentials:</strong>
                            <br>Go to "APIs & Services" ‚Üí "Credentials" ‚Üí "Create Credentials" ‚Üí "OAuth client ID"
                            <br>Application type: "Web application"
                            <br>Authorized redirect URIs: Add your server URL + <code>/api/oauth/callback</code>
                            <br>Example: <code>https://hanweir.146sharon.com/api/oauth/callback</code>
                        </li>
                        <li>
                            <strong>Download credentials.json:</strong>
                            <br>Download the OAuth client JSON file and save it as <code>credentials.json</code>
                            on your server at <code>/opt/mailtagger/credentials.json</code>
                        </li>
                        <li>
                            <strong>Click "Authorize Gmail" above:</strong>
                            <br>This will redirect you to Google to grant permissions.
                        </li>
                    </ol>
                    <p class="help-text" style="margin-top: 15px;">
                        <strong>Note:</strong> The OAuth credentials must have your server's URL 
                        as an authorized redirect URI in Google Cloud Console.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>

